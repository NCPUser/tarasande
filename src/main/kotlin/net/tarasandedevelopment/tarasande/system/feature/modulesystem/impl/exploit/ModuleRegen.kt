package net.tarasandedevelopment.tarasande.system.feature.modulesystem.impl.exploit

import net.minecraft.network.packet.c2s.play.PlayerMoveC2SPacket.OnGroundOnly
import net.tarasandedevelopment.tarasande.event.EventUpdate
import net.tarasandedevelopment.tarasande.system.base.valuesystem.impl.ValueBoolean
import net.tarasandedevelopment.tarasande.system.base.valuesystem.impl.ValueNumber
import net.tarasandedevelopment.tarasande.system.feature.modulesystem.Module
import net.tarasandedevelopment.tarasande.system.feature.modulesystem.ModuleCategory
import net.tarasandedevelopment.tarasande.util.extension.mc
import net.tarasandedevelopment.tarasande.util.math.TimeUtil

class ModuleRegen : Module("Regen", "Increases the rate of regeneration", ModuleCategory.EXPLOIT) {

    private val packets = ValueNumber(this, "Packets", 1.0, 5.0, 100.0, 1.0)
    private val delay = ValueNumber(this, "Delay", 0.0, 0.0, 1000.0, 50.0)
    private val preventIllegalPacket = ValueBoolean(this, "Prevent illegal packet", true)

    private val timeUtil = TimeUtil()

    init {
        registerEvent(EventUpdate::class.java) { event ->
            if (event.state == EventUpdate.State.POST) {
                if (timeUtil.hasReached(delay.value.toLong())) {
                    if (preventIllegalPacket.value) { // This will lead to more flags, but prevents simple protocol checks
                        var onGround = !mc.player?.isOnGround!!
                        for (i in 0 until packets.value.toInt()) {
                            mc.networkHandler?.sendPacket(OnGroundOnly(onGround))
                            onGround = !onGround
                        }
                        mc.player?.lastOnGround = onGround
                    } else {
                        for (i in 0 until packets.value.toInt()) {
                            mc.networkHandler?.sendPacket(OnGroundOnly(mc.player?.isOnGround!!))
                        }
                    }
                    timeUtil.reset()
                }
            }
        }
    }

}